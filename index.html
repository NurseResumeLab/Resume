<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Resume Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#f5f7fb; --panel:#ffffff; --border:#e6e8ef; --text:#0f172a; --muted:#6b7280;
    --primary:#2563eb; --primary-600:#1d4ed8; --chip:#eef2ff; --chip-text:#3730a3;
  }
  body{ font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text); margin:0; }
  h1{ margin:16px 0; text-align:center; font-weight:700; letter-spacing:.2px; }
  .hidden{ display:none; }

  .topbar{ position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:1px solid var(--border);
    padding:10px 16px; display:flex; align-items:center; gap:12px; justify-content:center; }
  .topbar .title{ font-weight:700; font-size:18px; }
  .app{ max-width:1400px; margin:12px auto 32px; padding:0 16px; }

  .container{ display:flex; gap:16px; flex-wrap:wrap; }
  .form-section{ flex:0 0 clamp(300px,26vw,380px); max-width:clamp(300px,26vw,380px); background:var(--panel); border:1px solid var(--border); border-radius:12px;
    padding:14px; box-shadow:0 1px 2px rgba(15,23,42,.04); max-height:90vh; overflow:auto; }
  .preview-section{ flex:1 1 0%; min-width:0; background:var(--panel); border:1px solid var(--border);
    border-radius:12px; box-shadow:0 1px 2px rgba(15,23,42,.04); overflow:auto; }

  .form-section label{ font-weight:600; font-size:13px; margin-top:10px; color:#111827; }
  .form-section input,.form-section textarea,.form-section select{ width:100%; padding:10px 12px; margin-top:6px; font-size:14px; border:1px solid var(--border); border-radius:10px; background:#fff; outline:none; transition:border-color .15s, box-shadow .15s; }
  .form-section textarea{ resize:vertical; }
  .form-section input:focus,.form-section textarea:focus,.form-section select:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.12); }

  .field-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px; }
  .subtle{ color:var(--muted); font-size:12px; }

  .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-primary:hover{ background:var(--primary-600); }
  .btn-ghost{ background:#fff; color:#0f172a; border:1px solid var(--border); }
  .btn-ghost:hover{ background:#f8fafc; }

  #add-experience,#add-education,#add-skill,#add-cert{
    display:inline-flex; align-items:center; gap:6px; padding:8px 12px; background:var(--primary); color:#fff; border:none; border-radius:10px; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,.06);
  }
  #add-experience::before,#add-education::before,#add-skill::before,#add-cert::before{ content:"+"; font-weight:700; }

  .buttons{ margin:16px 0 0; display:flex; gap:10px; flex-wrap:wrap; }

  .view-controls{ display:flex; gap:12px; align-items:center; margin-top:12px; padding:10px; border:1px solid var(--border); background:#fafbff; border-radius:10px; }
  .switch{ display:inline-flex; align-items:center; gap:8px; font-size:13px; color:#111827; }
  .switch input{ width:18px; height:18px; }

  #atsKeywords{ background:#fafbff; padding:10px; margin-bottom:12px; border:1px dashed var(--border); border-radius:10px; max-height:140px; overflow:auto; }
  #atsKeywords span{ display:inline-flex; align-items:center; padding:6px 10px; margin:4px; border-radius:999px; background:var(--chip); color:var(--chip-text); font-weight:600; font-size:12px; cursor:pointer; user-select:none; border:1px solid #e0e7ff; transition:all .15s; }
  #atsKeywords span:hover{ transform:translateY(-1px); box-shadow:0 2px 6px rgba(37,99,235,.12); }
  #atsKeywords span.used{ background:#22c55e1a; color:#166534; border-color:#bbf7d0; }
  #atsKeywords span.selected{ background:#dbeafe; color:#1e40af; border-color:#93c5fd; }

  .resume-preview{ background:#fff; width:8.5in; margin:0; box-sizing:border-box; font-family:"Times New Roman", Times, serif; font-size:12pt; line-height:1.4; color:#000; -webkit-print-color-adjust:exact; print-color-adjust:exact; transform-origin:top left; }
  .resume-content{ padding:0.5in; }
  .header-info{ margin-bottom:10px; border-bottom:2px solid #333; padding-bottom:5px; }
  .header-name{ font-weight:700; font-size:16pt; margin:0 0 2px; }
  .contact-info{ margin-bottom:3px; }
  .section-title{ font-weight:700; margin:14px 0 6px; text-transform:uppercase; color:#333; border-bottom:1px solid #ccc; padding-bottom:2px; page-break-inside:avoid; break-inside:avoid; }
  .entry{ margin-bottom:10px; position:relative; padding-right:30px; }
  .entry-title{ font-weight:700; }
  .entry-details{ font-style:italic; color:#555; margin-bottom:3px; }
  .entry-description{ margin-left:15px; }
  .delete-btn{ position:absolute; right:0; top:0; background:#ef4444; color:#fff; border:none; padding:0 8px; line-height:22px; height:22px; cursor:pointer; border-radius:6px; }

  /* Ensure bullets always show */
  .resume-preview ul.entry-description{ list-style:disc; padding-left:1.1em; margin:0.25em 0 0.5em; }
  .resume-preview ul.entry-description li{ list-style:disc; }

  .resume-preview.layout-compact .resume-content{ padding:0.4in; }
  .resume-preview.layout-compact .section-title{ margin-top:10px; margin-bottom:4px; border-bottom-color:#bbb; }
  .resume-preview.layout-compact .entry{ margin-bottom:6px; padding-right:24px; }
  .resume-preview.layout-compact .header-info{ margin-bottom:6px; padding-bottom:4px; }
  .resume-preview.layout-compact .contact-info{ display:inline; margin-right:10px; }

  .resume-preview.layout-centered .header-info{ text-align:center; border-bottom-width:3px; }
  .resume-preview.layout-centered .header-name{ font-size:18pt; letter-spacing:.3px; }
  .resume-preview.layout-centered .contact-info{ display:inline-block; margin:0 8px 6px; }
  .resume-preview.layout-centered .section-title{ border-bottom-width:2px; }

  /* Sidebar ordering to keep Skills/Certs high (right column next to Summary) */
  .resume-preview.layout-sidebar .resume-content{ display:grid; grid-template-columns:2fr 1fr; column-gap:24px; row-gap:8px; grid-auto-flow:dense; }
  .resume-preview.layout-sidebar .resume-content > .header-info{ grid-column:1/-1; }
  .resume-preview.layout-sidebar #summarySection{ grid-column:1; grid-row:2; }
  .resume-preview.layout-sidebar #experienceSection{ grid-column:1; grid-row:3; }
  .resume-preview.layout-sidebar #educationSection{ grid-column:1; grid-row:4; }
  .resume-preview.layout-sidebar #skillsSection{ grid-column:2; grid-row:2; }
  .resume-preview.layout-sidebar #certsSection{ grid-column:2; grid-row:3; }
  .resume-preview.layout-sidebar .section-title{ border-bottom-width:2px; }

  .resume-preview.layout-timeline .entry{ display:grid; grid-template-columns:2fr 1fr; align-items:baseline; padding-right:0; }
  .resume-preview.layout-timeline .entry-title{ grid-column:1; }
  .resume-preview.layout-timeline .entry-details{ grid-column:2; text-align:right; margin-bottom:0; }
  .resume-preview.layout-timeline .entry-description{ grid-column:1/-1; margin-left:0; }
  .resume-preview.layout-timeline .section-title{ border-bottom-width:2px; }

  .resume-preview.layout-classic .section-title{ border-bottom-width:1px; }

  .resume-preview .section-title{ break-after:avoid; page-break-after:avoid; }
  .resume-preview .entry,.resume-preview .resume-content>div{ break-inside:avoid; page-break-inside:avoid; }
  .resume-preview .entry-description,.resume-preview .entry-description li{ break-inside:avoid; page-break-inside:avoid; }
  .page-break{ break-before:page; page-break-before:always; border-top:1px dashed #bbb; margin:12px 0; }
  .page-break.hidden{ border-top:none; margin:0; height:0; }

  @page{ margin:0; }
  #resumePreview{ display:block; margin:0; }

  .print-controls{ margin-top:12px; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fafbff; }
  .print-controls__title{ font-weight:700; margin-bottom:6px; }
  .print-controls__group{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
  .print-controls__group label{ display:inline-flex; align-items:center; gap:8px; white-space:nowrap; }
  .print-controls input[type="checkbox"]{ width:18px; height:18px; }

  @media (max-width:1200px){ .container{ gap:12px; } .preview-section{ flex-basis:100%; min-width:0; } #resumePreview{ margin:0 auto; } }
</style>
</head>
<body>

<h1 id="accessDenied" class="hidden">Access Denied</h1>

<div id="protectedContent" class="hidden">
  <div class="topbar"><span class="title">Resume Builder</span></div>
  <div class="app">
    <div class="container">
      <!-- LEFT: Form -->
      <div class="form-section" aria-label="Resume Form">
        <label>ATS Keywords <span class="subtle">(click to add to Skills)</span></label>
        <div id="atsKeywords" title="Click a keyword to add it to your Skills. It will highlight green when used."></div>

        <label for="theme">Select Color</label>
        <select id="theme">
          <option value="classic">Classic (Navy)</option><option value="modern">Modern (Slate)</option>
          <option value="elegant">Elegant (Burgundy)</option><option value="minimal">Minimal (Charcoal)</option>
          <option value="royal">Royal (Indigo)</option><option value="plum">Plum (Deep Purple)</option>
          <option value="gold">Gold (Muted Ochre)</option><option value="copper">Copper (Burnt Orange)</option>
          <option value="azure">Azure (Clean Blue)</option>
        </select>

        <label for="layout">Layout Style</label>
        <select id="layout">
          <option value="classic">Classic (Single Column)</option>
          <option value="compact">Compact (Tighter Spacing)</option>
          <option value="sidebar">Sidebar (Skills & Certs Right)</option>
          <option value="timeline">Timeline (Right-Aligned Dates)</option>
          <option value="centered">Centered Header (Clean)</option>
        </select>

        <label for="fontFamily">Font Family</label>
        <select id="fontFamily">
          <option value="Times New Roman, Times, serif">Times New Roman</option>
          <option value="Arial, sans-serif">Arial</option>
          <option value="Roboto, sans-serif" selected>Roboto</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="Verdana, sans-serif">Verdana</option>
          <option value="Tahoma, sans-serif">Tahoma</option>
        </select>

        <label for="fontSize">Font Size</label>
        <select id="fontSize">
          <option value="10pt">10 pt</option><option value="11pt">11 pt</option>
          <option value="12pt" selected>12 pt</option><option value="13pt">13 pt</option>
          <option value="14pt">14 pt</option><option value="16pt">16 pt</option>
        </select>

        <label for="name">Your Name</label>
        <input id="name" type="text" placeholder="Full Name" />

        <label for="title">Your Title</label>
        <input id="title" type="text" placeholder="Registered Nurse, ICU Nurse, etc." />

        <label for="phone">Phone</label>
        <input id="phone" type="text" placeholder="(123) 456-7890" />

        <label for="email">Email</label>
        <input id="email" type="text" placeholder="you@email.com" />

        <label for="specialty">Professional Summary / Objective</label>
        <select id="specialty">
          <option value="">-- Choose Nurse Specialty Template --</option>
          <option value="medsurg">Medical-Surgical Nurse</option>
          <option value="icu">ICU Nurse</option>
          <option value="er">Emergency Room Nurse</option>
          <option value="travel">Travel Nurse</option>
          <option value="leadership">Nurse Leadership</option>
          <option value="newgrad">New Graduate Nurse</option>
        </select>
        <textarea id="summary" rows="5" placeholder="Concise 3-4 lines that showcase your value, scope (units/settings), and key strengths."></textarea>

        <div id="experience-section">
          <div class="field-header">
            <label>Experience Entries</label>
            <button type="button" id="add-experience" class="btn btn-primary">Add Experience</button>
          </div>
          <div class="subtle">Tip: Use bullets and start with strong verbs. Quantify where possible.</div>
        </div>

        <div id="education-section">
          <div class="field-header">
            <label>Education Entries</label>
            <button type="button" id="add-education" class="btn btn-primary">Add Education</button>
          </div>
        </div>

        <div id="skills-section">
          <div class="field-header">
            <label>Skills</label>
            <button type="button" id="add-skill" class="btn btn-primary">Add Skill</button>
          </div>
          <div class="subtle">Use line breaks for bullets (commas are ignored).</div>
        </div>

        <div id="cert-section">
          <div class="field-header">
            <label>Certifications</label>
            <button type="button" id="add-cert" class="btn btn-primary">Add Certification</button>
          </div>
          <div class="subtle">e.g., BLS, ACLS, PALS, CCRN, TNCC, NIHSS.</div>
        </div>

        <div class="view-controls" role="group" aria-label="View Controls">
          <label class="switch"><input type="checkbox" id="fitToggle" checked /> Fit to screen</label>
          <label class="switch"><input type="checkbox" id="guideToggle" checked /> Show break guides</label>
        </div>

        <div class="print-controls">
          <div class="print-controls__title">Page Breaks</div>
          <div class="print-controls__group">
            <label><input type="checkbox" id="pbBeforeExperience" /> Break before Experience</label>
            <label><input type="checkbox" id="pbBeforeEducation" /> Break before Education</label>
            <label><input type="checkbox" id="pbBeforeSkills" /> Break before Skills</label>
          </div>
        </div>

        <div class="buttons">
          <button id="resetBtn" class="btn btn-ghost">Reset</button>
          <button id="downloadBtn" class="btn btn-primary">Download PDF</button>
        </div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="preview-section" aria-label="Resume Preview">
        <div id="resumePreview" class="resume-preview">
          <div class="resume-content">
            <div class="header-info">
              <div class="header-name" id="prevName">Full Name</div>
              <div id="prevTitle">Title</div>
              <div class="contact-info" id="prevPhone">Phone</div>
              <div class="contact-info" id="prevEmail">Email</div>
            </div>

            <!-- Tag each section wrapper for sidebar placement -->
            <div id="summarySection">
              <div class="section-title">Professional Summary</div>
              <div id="prevSummary"></div>
            </div>
            <div id="experienceSection">
              <div class="section-title">Experience</div>
              <div id="prevExperience"></div>
            </div>
            <div id="educationSection">
              <div class="section-title">Education</div>
              <div id="prevEducation"></div>
            </div>
            <div id="skillsSection">
              <div class="section-title">Skills</div>
              <div id="prevSkills"></div>
            </div>
            <div id="certsSection">
              <div class="section-title">Certifications</div>
              <div id="prevCerts"></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /container -->
  </div><!-- /app -->
</div><!-- /protected -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
/* -------------------- Gate -------------------- */
const password = "NURSERESUME2025";
const userInput = prompt("Enter password to access this page:");
if (userInput === password) {
  document.getElementById("protectedContent").classList.remove("hidden");
} else {
  document.getElementById("accessDenied").classList.remove("hidden");
}

/* -------------------- App -------------------- */
if (userInput === password) {

  const themeColors = {
    classic:'#0b3d91', modern:'#6c757d', elegant:'#800020', minimal:'#333333',
    royal:'#3b3b98', plum:'#4c1d95', gold:'#8b6b22', copper:'#b45309', azure:'#2563eb'
  };

  const specialties = {
    medsurg:`Experienced Medical-Surgical Nurse with strong track record providing comprehensive patient care in diverse healthcare settings. Skilled in assessments, care planning, and interdisciplinary collaboration to improve patient outcomes.`,
    icu:`ICU Nurse with extensive experience caring for critically ill patients. Proficient in monitoring, ventilator management, and rapid response interventions, delivering safe and effective care in high-stress environments.`,
    er:`Emergency Room Nurse experienced in rapid triage, acute care interventions, and managing multiple emergencies simultaneously. Strong skills in critical decision-making and patient stabilization.`,
    travel:`Travel Nurse with adaptability to diverse healthcare environments, quickly integrating into new teams and delivering consistent, high-quality care. Skilled in patient education, clinical assessments, and teamwork.`,
    leadership:`Nursing professional with leadership experience managing clinical teams, improving workflow efficiency, mentoring staff, and ensuring compliance with healthcare standards and policies.`,
    newgrad:`Recent nursing graduate with strong academic foundation and clinical experience. Skilled in patient care, documentation, and eager to contribute to a dynamic healthcare team while continuing professional development.`
  };

  /* ---------- ATS chips ---------- */
  const atsKeywordsList = ["Patient Care","Critical Thinking","Assessment","Communication","EMR","Team Collaboration","Medication Administration","ICU","ER","Leadership","Travel Nursing","New Graduate","Evidence-Based","Compassion","Quality Improvement"];
  const atsContainer = document.getElementById('atsKeywords');
  atsKeywordsList.forEach(word=>{
    const span=document.createElement('span'); span.textContent=word; span.title="Click to add to Skills";
    span.addEventListener('click',()=>{
      const firstSkill = document.querySelector('#skills-section .entry .skill-text') || createDefaultSkillEntry();
      const val = firstSkill.value.trim();
      const exists = new RegExp(`(^|[\\n]\\s*)${escapeRegExp(word)}(\\s*([\\n]|$))`,'i').test(val);
      if(!exists){
        // add via newline, not commas
        firstSkill.value = (val ? (val + (val.endsWith('\\n') ? '' : '\\n')) : '') + word;
      }
      span.classList.toggle('selected');
      updatePreview();
    });
    atsContainer.appendChild(span);
  });

  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&'); }
  function formatDate(dateStr){
    if (!dateStr) return '';
    if (String(dateStr).toLowerCase() === 'present') return 'Present';
    const d=new Date(dateStr); if(isNaN(d)) return '';
    return d.toLocaleString('default',{month:'long',year:'numeric'});
  }
  function createDefaultSkillEntry(){
    addSkillOrCert('skills-section','skill-text','Skill...');
    return document.querySelector('#skills-section .entry .skill-text');
  }

  /* ===== Fit & Guides ===== */
  let fitEnabled = true;
  const fitToggle = document.getElementById('fitToggle');
  const guideToggle = document.getElementById('guideToggle');
  fitToggle.addEventListener('change',()=>{ fitEnabled = fitToggle.checked; fitPreview(); saveState(); });
  guideToggle.addEventListener('change',()=>{
    document.querySelectorAll('.page-break').forEach(el=> el.classList.toggle('hidden', !guideToggle.checked) );
    saveState();
  });

  function fitPreview(){
    const wrap = document.querySelector('.preview-section');
    const el = document.getElementById('resumePreview');
    if(!wrap || !el) return;
    if(!fitEnabled){ el.style.transform = 'none'; wrap.style.minHeight = ''; return; }
    const scale = Math.min(1, wrap.clientWidth / el.offsetWidth);
    el.style.transform = `scale(${scale})`;
    wrap.style.minHeight = (el.offsetHeight * scale + 2) + 'px';
  }
  window.addEventListener('resize', fitPreview);

  function applyManualBreaks(){
    const resume = document.getElementById('resumePreview');
    if(!resume) return;
    resume.querySelectorAll('.page-break').forEach(el=>el.remove());
    const expWrap = document.getElementById('prevExperience')?.parentElement;
    const eduWrap = document.getElementById('prevEducation')?.parentElement;
    const sklWrap = document.getElementById('prevSkills')?.parentElement;
    if(document.getElementById('pbBeforeExperience')?.checked && expWrap){
      const br=document.createElement('div'); br.className='page-break'; if(!guideToggle.checked) br.classList.add('hidden');
      expWrap.parentElement.insertBefore(br, expWrap);
    }
    if(document.getElementById('pbBeforeEducation')?.checked && eduWrap){
      const br=document.createElement('div'); br.className='page-break'; if(!guideToggle.checked) br.classList.add('hidden');
      eduWrap.parentElement.insertBefore(br, eduWrap);
    }
    if(document.getElementById('pbBeforeSkills')?.checked && sklWrap){
      const br=document.createElement('div'); br.className='page-break'; if(!guideToggle.checked) br.classList.add('hidden');
      sklWrap.parentElement.insertBefore(br, sklWrap);
    }
  }

  /* ===== Auto-save / restore ===== */
  const STORAGE_KEY = 'resumeBuilderState_v5';
  function saveState(){
    const state = {
      name:val('name'), title:val('title'), phone:val('phone'), email:val('email'),
      theme:val('theme'), layout:val('layout'), fontFamily:val('fontFamily'), fontSize:val('fontSize'),
      specialty:val('specialty'), summary:val('summary'),
      breaks:{ exp:checked('pbBeforeExperience'), edu:checked('pbBeforeEducation'), skl:checked('pbBeforeSkills'),
        fit:fitToggle.checked, guides:guideToggle.checked },
      experience: Array.from(document.querySelectorAll('#experience-section .entry')).map(e=>({
        job:gv(e,'.job-title'), employer:gv(e,'.employer'), city:gv(e,'.city'), state:gv(e,'.state'),
        start:gv(e,'.start-date'),
        end: (e.querySelector('.present-chk')?.checked ? 'present' : gv(e,'.end-date')),
        present: !!e.querySelector('.present-chk')?.checked,
        descType:gv(e,'.desc-type'), desc:gv(e,'.description')
      })),
      education: Array.from(document.querySelectorAll('#education-section .entry')).map(e=>({
        degree:gv(e,'.degree'), school:gv(e,'.school'), city:gv(e,'.city'), state:gv(e,'.state'),
        gradYear:gv(e,'.grad-year')
      })),
      skills: Array.from(document.querySelectorAll('#skills-section .entry .skill-text')).map(t=>t.value),
      certs: Array.from(document.querySelectorAll('#cert-section .entry .cert-name')).map(t=>t.value)
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      setVal('name',s.name); setVal('title',s.title); setVal('phone',s.phone); setVal('email',s.email);
      setVal('theme',s.theme); setVal('layout',s.layout); setVal('fontFamily',s.fontFamily); setVal('fontSize',s.fontSize);
      setVal('specialty',s.specialty); setVal('summary',s.summary);

      (s.experience||[]).forEach(it=>{
        const node = addEntryAfter(null,'experience-section',expMarkup()); // append
        sv(node,'.job-title',it.job); sv(node,'.employer',it.employer); sv(node,'.city',it.city); sv(node,'.state',it.state);
        sv(node,'.start-date',it.start);
        const presentChk = node.querySelector('.present-chk');
        const end = node.querySelector('.end-date');
        if (it.present || String(it.end).toLowerCase()==='present') {
          presentChk.checked = true; end.value = ''; end.disabled = true; end.placeholder = 'Present';
        } else { sv(node,'.end-date',it.end); }
        sv(node,'.desc-type',it.descType||'paragraph'); sv(node,'.description',it.desc);
      });
      (s.education||[]).forEach(it=>{
        const node = addEntryAfter(null,'education-section',eduMarkup());
        sv(node,'.degree',it.degree); sv(node,'.school',it.school); sv(node,'.city',it.city); sv(node,'.state',it.state);
        sv(node,'.grad-year',it.gradYear);
      });

      rebuildListSection('skills-section','skill-text','Skill...', s.skills);
      rebuildListSection('cert-section','cert-name','Certification...', s.certs);

      byId('pbBeforeExperience').checked = !!(s.breaks&&s.breaks.exp);
      byId('pbBeforeEducation').checked = !!(s.breaks&&s.breaks.edu);
      byId('pbBeforeSkills').checked = !!(s.breaks&&s.breaks.skl);
      fitToggle.checked = s.breaks?.fit ?? true; fitEnabled = fitToggle.checked;
      guideToggle.checked = s.breaks?.guides ?? true;
    }catch(e){}
  }
  function val(id){ const el=byId(id); return el?el.value:''; }
  function setVal(id,v){ const el=byId(id); if(el!=null && v!=null) el.value=v; }
  function checked(id){ const el=byId(id); return !!(el && el.checked); }
  function gv(root,sel){ const el=root.querySelector(sel); return el?el.value:''; }
  function sv(root,sel,v){ const el=root.querySelector(sel); if(el!=null && v!=null) el.value=v; }
  function byId(id){ return document.getElementById(id); }

  function rebuildListSection(containerId, cls, placeholder, arr){
    document.querySelectorAll('#'+containerId+' .entry').forEach(n=>n.remove());
    if (!arr || arr.length===0) { addSkillOrCert(containerId, cls, placeholder); return; }
    arr.forEach(txt=>{ const d=addSkillOrCert(containerId, cls, placeholder); d.querySelector('textarea').value = txt; });
  }

  /* ===== Update Preview ===== */
  function updatePreview(){
    const name=val('name')||'Full Name';
    const title=val('title')||'Title';
    const phone=val('phone')||'Phone';
    const email=val('email')||'Email';
    const theme=val('theme')||'classic';

    byId('prevName').textContent=name;
    byId('prevTitle').textContent=title;
    byId('prevPhone').textContent=phone;
    byId('prevEmail').textContent=email;

    document.querySelector('.header-info').style.borderBottomColor = themeColors[theme];
    document.querySelectorAll('.section-title').forEach(el=>el.style.color = themeColors[theme]);

    const resumeEl = byId('resumePreview');
    resumeEl.style.fontFamily = val('fontFamily');
    resumeEl.style.fontSize = val('fontSize');

    const layout = val('layout') || 'classic';
    const layoutClasses = ['layout-classic','layout-compact','layout-sidebar','layout-timeline','layout-centered'];
    resumeEl.classList.remove(...layoutClasses);
    resumeEl.classList.add(`layout-${layout}`);

    byId('prevSummary').innerHTML = (val('summary')||'').replace(/\n/g,'<br>');

    // Experience
    const expContainer = byId('prevExperience'); expContainer.innerHTML='';
    document.querySelectorAll('#experience-section .entry').forEach(entry=>{
      const job=gv(entry,'.job-title'), employer=gv(entry,'.employer'), city=gv(entry,'.city'), state=gv(entry,'.state');
      const start=gv(entry,'.start-date');
      const present = entry.querySelector('.present-chk')?.checked;
      const end = present ? 'present' : gv(entry,'.end-date');
      const descType=gv(entry,'.desc-type'), desc=gv(entry,'.description');
      if(job || employer){
        let html = `<div class="entry"><div class="entry-title">${job||''}</div>`;
        const place = [employer, city, state].filter(Boolean).join(', ');
        const dates = (start || end) ? ` | ${formatDate(start)} - ${formatDate(end)}` : '';
        html += `<div class="entry-details">${place}${dates}</div>`;
        if(desc){
          if(descType==='bullet'){
            const bullets = desc.split(/\r?\n/).map(d=>d.trim()).filter(Boolean).map(d=>`<li>${d}</li>`).join('');
            html += `<ul class="entry-description">${bullets}</ul>`;
          } else {
            html += `<div class="entry-description">${desc.replace(/\n/g,'<br>')}</div>`;
          }
        }
        html += `</div>`;
        expContainer.insertAdjacentHTML('beforeend', html);
      }
    });

    // Education
    const eduContainer = byId('prevEducation'); eduContainer.innerHTML='';
    document.querySelectorAll('#education-section .entry').forEach(entry=>{
      const degree=gv(entry,'.degree'), school=gv(entry,'.school'), city=gv(entry,'.city'), state=gv(entry,'.state');
      const gradYear=gv(entry,'.grad-year');
      if(degree || school){
        const details = [school, city, state].filter(Boolean).join(', ');
        const yearPart = gradYear ? ` | Graduated (${gradYear})` : '';
        eduContainer.insertAdjacentHTML('beforeend',
          `<div class="entry"><div class="entry-title">${degree||''}</div><div class="entry-details">${details}${yearPart}</div></div>`
        );
      }
    });

    // Skills (bullets from line breaks ONLY)
    const skillContainer = byId('prevSkills'); skillContainer.innerHTML='';
    document.querySelectorAll('#skills-section .entry').forEach(entry=>{
      const text = entry.querySelector('.skill-text')?.value || '';
      const bullets = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(s=>`<li>${s}</li>`).join('');
      if(bullets){ skillContainer.insertAdjacentHTML('beforeend', `<ul class="entry-description">${bullets}</ul>`); }
    });

    // Certifications
    const certContainer = byId('prevCerts'); certContainer.innerHTML='';
    document.querySelectorAll('#cert-section .entry').forEach(entry=>{
      const name = entry.querySelector('.cert-name')?.value;
      if(name){ certContainer.insertAdjacentHTML('beforeend', `<div class="entry"><div class="entry-title">${name}</div></div>`); }
    });

    // ATS highlights
    atsContainer.querySelectorAll('span').forEach(span=>{
      const text = ( val('summary') + " " +
        Array.from(document.querySelectorAll('#experience-section .entry .description')).map(d=>d.value).join(' ') + " " +
        Array.from(document.querySelectorAll('#skills-section .entry .skill-text')).map(d=>d.value).join(' ')
      ).toLowerCase();
      span.classList.toggle('used', text.includes(span.textContent.toLowerCase()));
    });

    applyManualBreaks();
    fitPreview();
    saveState();
  }

  /* ===== Focus-aware insertion: add below current card ===== */
  let currentExpEntry = null;
  let currentEduEntry = null;
  document.getElementById('experience-section').addEventListener('focusin', (e)=>{
    const card = e.target.closest('.entry'); if(card) currentExpEntry = card;
  });
  document.getElementById('education-section').addEventListener('focusin', (e)=>{
    const card = e.target.closest('.entry'); if(card) currentEduEntry = card;
  });

  /* ===== Entry Markups ===== */
  function expMarkup(){
    return `
      <div class="entry-card">
        <input type="text" class="job-title" placeholder="Job Title">
        <input type="text" class="employer" placeholder="Employer">
        <input type="text" class="city" placeholder="City">
        <input type="text" class="state" placeholder="State">
        <label class="subtle">Start / End Date</label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input type="date" class="start-date" style="flex:1"> <span class="subtle">—</span>
          <input type="date" class="end-date" style="flex:1">
          <label class="subtle" style="display:inline-flex; align-items:center; gap:6px;">
            <input type="checkbox" class="present-chk"> Present
          </label>
        </div>
        <label class="subtle">Description</label>
        <select class="desc-type"><option value="paragraph">Paragraph</option><option value="bullet">Bullet Points</option></select>
        <textarea class="description" rows="3" placeholder="One item per line for bullets."></textarea>
        <button class="delete-btn" title="Remove">✕</button>
      </div>
    `;
  }
  function eduMarkup(){
    const thisYear = new Date().getFullYear();
    return `
      <div class="entry-card">
        <input type="text" class="degree" placeholder="Degree / Certification">
        <input type="text" class="school" placeholder="School / Institution">
        <input type="text" class="city" placeholder="City">
        <input type="text" class="state" placeholder="State">
        <label class="subtle">Graduated (Year)</label>
        <input type="number" class="grad-year" min="1950" max="${thisYear+6}" step="1" placeholder="${thisYear}">
        <button class="delete-btn" title="Remove">✕</button>
      </div>
    `;
  }

  /* ===== Add helpers (insert after current) ===== */
  function addEntryAfter(afterNode, containerId, htmlContent){
    const container = byId(containerId);
    const div = document.createElement('div'); div.className='entry'; div.innerHTML=htmlContent;

    const del = div.querySelector('.delete-btn');
    if(del) del.addEventListener('click',()=>{ div.remove(); ensureAtLeastOneListItem(containerId); updatePreview(); });

    // listen for input & select changes
    div.querySelectorAll('input,textarea,select').forEach(el=>{
      el.addEventListener('input', updatePreview);
      el.addEventListener('change', updatePreview);
    });

    // Present checkbox behavior
    const present = div.querySelector('.present-chk');
    const endInput = div.querySelector('.end-date');
    if (present && endInput) {
      present.addEventListener('change',()=>{
        if(present.checked){ endInput.value=''; endInput.disabled=true; endInput.placeholder='Present'; }
        else { endInput.disabled=false; endInput.placeholder=''; }
        updatePreview();
      });
    }

    if (afterNode && afterNode.parentNode === container) {
      afterNode.after(div);         // insert below current focused card
    } else {
      container.appendChild(div);   // otherwise append to end
    }
    updatePreview();
    return div;
  }

  function ensureAtLeastOneListItem(containerId){
    if((containerId==='skills-section' || containerId==='cert-section') &&
       document.querySelectorAll('#'+containerId+' .entry').length===0){
      if(containerId==='skills-section') addSkillOrCert('skills-section','skill-text','Skill...');
      if(containerId==='cert-section') addSkillOrCert('cert-section','cert-name','Certification...');
    }
  }

  function addSkillOrCert(containerId, className, placeholder){
    const container=document.getElementById(containerId);
    const div=document.createElement('div'); div.className='entry';
    div.innerHTML=`<textarea class="${className}" rows="2" placeholder="${placeholder}"></textarea>
      <button class="delete-btn" title="Remove">✕</button>`;
    div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); ensureAtLeastOneListItem(containerId); updatePreview(); });
    const ta = div.querySelector('textarea');
    ta.addEventListener('input',updatePreview);
    ta.addEventListener('change',updatePreview);
    container.appendChild(div);
    return div;
  }

  /* ===== Wire up actions ===== */
  document.getElementById('add-experience').addEventListener('click',()=>{
    addEntryAfter(currentExpEntry,'experience-section', expMarkup());
  });
  document.getElementById('add-education').addEventListener('click',()=>{
    addEntryAfter(currentEduEntry,'education-section', eduMarkup());
  });
  document.getElementById('add-skill').addEventListener('click',()=>addSkillOrCert('skills-section','skill-text','Skill...'));
  document.getElementById('add-cert').addEventListener('click',()=>addSkillOrCert('cert-section','cert-name','Certification...'));

  // seed one skills & one cert
  addSkillOrCert('skills-section','skill-text','Skill...');
  addSkillOrCert('cert-section','cert-name','Certification...');

  ['theme','fontFamily','fontSize','layout'].forEach(id=>{
    byId(id).addEventListener('change',updatePreview);
    byId(id).addEventListener('input',updatePreview);
  });
  ['summary','name','title','phone','email'].forEach(id=>byId(id).addEventListener('input',updatePreview));
  byId('specialty').addEventListener('change',function(){ const v=this.value; if(v) byId('summary').value=specialties[v]; updatePreview(); });
  ['pbBeforeExperience','pbBeforeEducation','pbBeforeSkills'].forEach(id=>{
    const el=byId(id); if(el) el.addEventListener('change', ()=>{ applyManualBreaks(); fitPreview(); saveState(); });
  });

  /* ===== PDF Export ===== */
  document.getElementById('downloadBtn').addEventListener('click', () => {
    const source = document.getElementById('resumePreview');
    const clone = source.cloneNode(true);
    clone.id = 'resumePreviewCapture';
    clone.style.margin = '0'; clone.style.boxShadow = 'none'; clone.style.transform = 'none';

    const host = document.createElement('div');
    host.id = 'captureHost'; host.style.position = 'fixed'; host.style.left = '0'; host.style.top = '0';
    host.style.width = '8.5in'; host.style.background = '#fff'; host.style.zIndex = '2147483647';
    host.style.padding = '0'; host.style.margin = '0'; host.appendChild(clone);
    document.body.appendChild(host);

    const opts = { margin: 0, filename: 'Resume.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      pagebreak: { mode: ['css','legacy'] },
      html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opts).from(clone).save().finally(()=>host.remove());
  });

  /* ===== Soft Reset (no reload) ===== */
  document.getElementById('resetBtn').addEventListener('click',()=>{
    localStorage.removeItem(STORAGE_KEY);
    ['name','title','phone','email','summary','specialty'].forEach(id=>{ const el=byId(id); if(el){ el.value = ''; }});
    setVal('theme','classic'); setVal('layout','classic'); setVal('fontFamily','Roboto, sans-serif'); setVal('fontSize','12pt');
    document.querySelectorAll('#experience-section .entry, #education-section .entry, #skills-section .entry, #cert-section .entry').forEach(n=>n.remove());
    addSkillOrCert('skills-section','skill-text','Skill...');
    addSkillOrCert('cert-section','cert-name','Certification...');
    byId('pbBeforeExperience').checked = false; byId('pbBeforeEducation').checked = false; byId('pbBeforeSkills').checked = false;
    byId('fitToggle').checked = true; fitEnabled = true; byId('guideToggle').checked = true;
    updatePreview();
  });

  /* ===== Boot ===== */
  loadState();
  updatePreview();
  fitPreview();
}
</script>
</body>
</html>
